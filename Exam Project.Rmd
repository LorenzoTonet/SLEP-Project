---
title: "Lung cancer survival analysis"
author: "Bortolussi Lorenzo, Cartago Marco, Tonet Lorenzo"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(survival)
library(survminer)
library(ggplot2)
library(corrplot)
library(dplyr)
library(tidyr)
library(ggExtra)
library(patchwork)
library(corrplot)
library(survminer)
```

# NCCTG Lung Cancer Data

## Dataset description


The dataset we chose to analyze is the `cancer` dataset from the r package `survival`. The dataset itself was first collected and analyzed by the North Central Cancer Treatment Group. In this prospective study, participants were provided with a questionnaire prior to hospitalization. Each patient was also evaluated by a physician, who assigned a performance score based on their clinical condition.

The variables collected are the following:

|           |                                                                                                                                                                                                    |
|:-----------------------------------|:-----------------------------------|
| inst      | The code of the institution in which the patient was hospitalized                                                                                                                                  |
| time      | The survival time in days                                                                                                                                                                          |
| status    | The censoring status                                                                                                                                                                               |
| age       | The age in years                                                                                                                                                                                   |
| sex       | Patient sex                                                                                                                                                                                        |
| ph.ecog   | ECOG performance score as rated by the physician. 0=asymptomatic, 1= symptomatic but completely ambulatory, 2= in bed \<50% of the day, 3= in bed \> 50% of the day but not bedbound, 4 = bedbound |
| ph.karno  | Karnofsky performance score (bad=0-good=100) rated by physician                                                                                                                                    |
| pat.karno | Karnofsky performance score as rated by the patient itself                                                                                                                                         |
| meal.cal  | Calories consumed at the meal before hospitalization                                                                                                                                               |
| wt.loss   | Weight loss in pounds in the last six months                                                                                                                                                       |

Most of the present variables are categorical. We decided to add another categorical variable, cutting the age range into three age ranges: 0-50, 50-70, 70+. We also converted some of the variables into categorical factors.


```{r importing dataset}
data = survival::cancer
```

```{r summary}
summary(data)
```

```{r factors to factors, echo = FALSE}
data$sex <- factor(data$sex)
data$status <- factor(data$status)
data$ph.ecog <- factor(data$ph.ecog)
data$ph.karno <- factor(data$ph.karno)
data$pat.karno <- factor(data$pat.karno)
```

```{r additional variables}
data$age.cat <- cut(
    data$age, 
    breaks=c(0, 50, 70, Inf), 
    labels=c("<50", "50-70", "70+")
)
```

## NAs

We first tried to see wether there is any systematic distribution of missing values inside the dataset. The first thing we did is a comprehensive NA plot for all the variables.

We then tried to stratify with respect to the different categorical variables, so to check if there was any substantial difference in the NA distribution.

Most of the missing values, around 20% of the total, are in the variable `meal.cal`. So for some initial data analysis we decided to ignore this variable


```{r na overview}
colSums(is.na(data))
```

```{r NA distribution}
nas <- data.frame(var=colnames(data), na=colSums(is.na(data)))
ggplot(nas, aes(x=var, y=na))+ 
  geom_bar(stat="identity")+
  xlab("Variables") +
  ylab("Number of NAs") +
  theme_grey()

```

```{r NAs (conditioned to sex)}

dataM <-data.frame(
  var=colnames(data[data$sex=="1",]), 
  sex="Male", 
  na=colSums(is.na(data[data$sex=="1",]))
)

dataF <- data.frame(
  var=colnames(data[data$sex=="2",]),
  sex="Female",
  na=colSums(is.na(data[data$sex=="2",]))
)

nas_conditioned <- rbind(dataM, dataF)
nas_conditioned_df <- data.frame(var=colnames(data), na=colSums(is.na(data)))

ggplot(nas_conditioned, aes(x=var, y=na))+ 
  xlab("Variables") +
  ylab("Number of NAs") +
  geom_bar(stat="identity")+
  facet_wrap(~sex) +
  coord_flip()
```

```{r NAs (conditioned to status)}
data1 <-data.frame(
  var=colnames(data[data$status=="1",]),
  status="1",
  na=colSums(is.na(data[data$status=="1",]))
)

data2 <- data.frame(
  var=colnames(data[data$status=="2",]),
  status="2",
  na=colSums(is.na(data[data$status=="2",]))
)


nass <- rbind(data1, data2)
nas <- data.frame(var=colnames(data), na=colSums(is.na(data)))

ggplot(nass, aes(x=var, y=na))+
  xlab("Variables") +
  ylab("Number of NAs") +
  geom_bar(stat="identity")+
  facet_wrap(~status) +
  coord_flip()
```

```{r NAs prediction}
hasna <- as.numeric(rowSums(is.na(data)) > 0)
na.corr.data <- cbind(data, hasna)
na.corr.data <- na.corr.data[-9]

m <- glm(
  hasna ~ inst + ph.ecog + ph.karno + pat.karno + sex + time,
  family = binomial(link="logit"),
  data=na.corr.data
)
```

## Exploratory data analysis

### Univariate analysis

```{r Age variable, warning=FALSE}

x_limits <- range(data$age)

p1 = ggplot(data = data, aes(x = age, y = after_stat(density))) +
  geom_histogram(bins = 20) +
  geom_density(alpha = 0.5, colour="darkgray") +
  labs(title = "Age Distribution", y = "Count") +
  scale_x_continuous(limits = x_limits) +
  theme_minimal()

p2 = ggplot(data = data, aes(x = age)) +
  geom_boxplot() +
  labs(x = "age") +
  scale_x_continuous(limits = x_limits) +
  theme_minimal()

p1 + p2 + plot_layout(heights = c(5,1))
```
```{r status barplot}

ggplot(data, aes(x=status))+
  geom_bar(aes(y = after_stat(prop), group = 1)) +
  scale_x_discrete(labels = c("1" = "Censored", "2" = "Dead")) +
  labs(x = "Status", y = "Proportion") +
  theme_grey()

```
```{r wt.loss variable, warning=FALSE}

x_limits <- range(data$wt.loss)

p1 = ggplot(data = data, aes(x = wt.loss, y = after_stat(density))) +
  geom_histogram(bins = 20) +
  geom_density(alpha = 0.5, colour="darkgray") +
  labs(title = "Weight loss Distribution") +
  scale_x_continuous(limits = x_limits) +
  theme_minimal()

p2 = ggplot(data = data, aes(x = wt.loss)) +
  geom_boxplot() +
  labs(x = "wt.loss") +
  scale_x_continuous(limits = x_limits) +
  theme_minimal()

p1 + p2 + plot_layout(heights = c(5,1))

```
```{r time distribution, warning=FALSE}

x_limits <- range(data$time)

p1 = ggplot(data = data, aes(x = time, y = after_stat(density))) +
  geom_histogram(bins = 20) +
  geom_density(alpha = 0.5, colour="darkgray") +
  labs(title = "Time distribution") +
  scale_x_continuous(limits = x_limits) +
  theme_minimal()

p2 = ggplot(data = data, aes(x = time)) +
  geom_boxplot() +
  labs(x = "time") +
  scale_x_continuous(limits = x_limits) +
  theme_minimal()

p1 + p2 + plot_layout(heights = c(5,1))

```
```{r meal.cal distribution, warning=FALSE}

x_limits <- range(data$meal.cal, na.rm = TRUE)

p1 = ggplot(data = data, aes(x = meal.cal, y = after_stat(density))) +
  geom_histogram(bins = 35) +
  geom_density(alpha = 0.5, colour="darkgray") +
  labs(title = "Meal Calories distribution") +
  scale_x_continuous(limits = x_limits) +
  theme_minimal()

p2 = ggplot(data = data, aes(x = meal.cal)) +
  geom_boxplot() +
  labs(x = "meal.cal") +
  scale_x_continuous(limits = x_limits) +
  theme_minimal()

p1 + p2 + plot_layout(heights = c(5,1))

```


### Bivariate analysis
```{r corr matrix, warning=FALSE}
original_data = survival::cancer
ds = subset(original_data, select=c(time, age, ph.ecog, ph.karno, pat.karno, wt.loss))
corr.mat <- cor(ds, use="pairwise.complete.obs", method="spearman")

corrplot(corr.mat, method="color", type="full", tl.col="black", tl.srt=45, 
         addCoef.col="black", number.cex=0.7, tl.cex=0.7, 
         title="Correlation Matrix of Numerical Variables", mar=c(0,0,1,0))
```

```{r pat vs ph karno}

ggplot(data, aes(x=pat.karno, y=ph.karno)) + 
  geom_jitter()

```

### Conditioning to status

```{r sex vs status, warning=FALSE}
library(ggmosaic)
tab = prop.table(table(data$status, data$sex))
df_tab = as.data.frame(tab)
colnames(df_tab) = c("status", "sex", "prop")

ggplot(data) +
  geom_mosaic(aes(x = product(sex, status), fill = status)) +
  scale_fill_discrete(guide = "none") +
  theme_minimal()
```

```{r evals vs status, warning=FALSE}
p1 = ggplot(data) +
  geom_mosaic(aes(x = product(ph.ecog, status), fill = ph.ecog), na.rm = TRUE) +
  scale_fill_discrete(guide = "none") +
  theme_minimal()

p2 = ggplot(data) +
  geom_mosaic(aes(x = product(ph.karno, status), fill = ph.karno), na.rm = TRUE) +
  scale_fill_discrete(guide = "none") +
  theme_minimal()

p3 = ggplot(data) +
  geom_mosaic(aes(x = product(pat.karno, status), fill = pat.karno), na.rm = TRUE) +
  scale_fill_discrete(guide = "none") +
  theme_minimal()

p1 + p2 + p3 + plot_layout(ncol = 3)

```

```{r time and wt.loss vs status, warning=FALSE}

p1 = ggplot(data, aes(x=status, y=time, fill = status)) +
  geom_violin(draw_quantiles = c(0.25,0.5,0.75)) +
  labs(x = "Status", y = "Time")
  
p2 = ggplot(data, aes(x=status, y=wt.loss, fill = status)) +
  geom_violin(draw_quantiles = c(0.25,0.5,0.75)) +
  labs(x = "Status", y = "Weight Loss") 
  
p1 + p2 + plot_layout(ncol = 2)
```
```{r time and wt.loss vs status2, warning=FALSE}
p <- ggplot(data, aes(x=time, y=wt.loss, color=status)) +
      geom_point()
    
p1 = ggMarginal(p, groupFill = T, type="boxplot")
p1
```

## Survival analysis

```{r KM estimator}
survfit_sex = survfit(Surv(time, status) ~ 1, data=original_data)

ggsurvplot(survfit_sex, 
           xlab="Days", 
           ylab="Overall survival probability",
           risk.table=TRUE,
           conf.int=TRUE,
           surv.median.line="hv", 
           data=original_data)
```


```{r KM with respect to age, warning=FALSE}

original_data$age.cat <- cut(original_data$age, breaks=c(0, 50, 70, 100), labels=c("<50", "50-70", "70+"))

survfit_ecog = survfit(Surv(time, event=status) ~ age.cat, data=original_data)
summary(survfit_ecog)
ggsurvplot(survfit_ecog, 
           xlab="Days", 
           ylab="Overall survival probability",
           risk.table=TRUE,
           risk.table.height=0.25,
           conf.int=TRUE,
           surv.median.line="hv", 
           data=original_data,
           break.x.by=250,  # Meno punti sull'asse x
           xlim=c(0,1000))

survdiff(Surv(time, status) ~ sex, original_data)
```

```{r KM with respect to ph.ecog, warning=FALSE}
survfit_ecog = survfit(Surv(time, event=status) ~ ph.ecog, data=original_data)
ggsurvplot(survfit_ecog, 
           xlab="Days", 
           ylab="Overall survival probability",
           risk.table=TRUE,
           conf.int=FALSE,
           surv.median.line="hv",
           data=original_data)

survdiff(Surv(time, status) ~ ph.ecog, original_data)
```


